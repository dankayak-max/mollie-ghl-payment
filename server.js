require('dotenv').config();const express=require('express');const axios=require('axios');const cors=require('cors');const bodyParser=require('body-parser');const app=express();app.use(cors());app.use(bodyParser.json());const PORT=process.env.PORT||3000;const MOLLIE_KEY_TEST=process.env.MOLLIE_API_KEY_TEST;const GHL_CLIENT_ID=process.env.GHL_CLIENT_ID;const GHL_CLIENT_SECRET=process.env.GHL_CLIENT_SECRET;const GHL_API='https://services.leadconnectorhq.com';const MOLLIE_API='https://api.mollie.com/v2';const BACKEND_URL=process.env.BACKEND_URL||`http://localhost:${PORT}`;const tokenStore={};app.get('/oauth-callback',async(req,res)=>{try{const{code,locationId}=req.query;if(!code||!locationId)return res.status(400).json({error:'Missing'});const tokenRes=await axios.post(`${GHL_API}/oauth/token`,{client_id:GHL_CLIENT_ID,client_secret:GHL_CLIENT_SECRET,grant_type:'authorization_code',code});tokenStore[locationId]={access_token:tokenRes.data.access_token};res.json({success:true,locationId});}catch(err){res.status(500).json({error:err.message});}});app.post('/create-mollie-payment',async(req,res)=>{try{const{amount,currency,orderId,locationId}=req.body;const token=tokenStore[locationId];if(!token)return res.status(401).json({error:'Not auth'});const mollieRes=await axios.post(`${MOLLIE_API}/payments`,{amount:{currency,value:(amount/100).toFixed(2)},description:`Order ${orderId}`,webhookUrl:`${BACKEND_URL}/mollie-webhook?locationId=${locationId}`},{ headers:{Authorization:`Bearer ${MOLLIE_KEY_TEST}`}});res.json({success:true,checkoutUrl:mollieRes.data.links.checkout.href});}catch(err){res.status(500).json({error:err.message});}});app.post('/mollie-webhook',async(req,res)=>{res.json({received:true});});app.post('/query',(req,res)=>{const{type}=req.body;if(type==='verify')return res.json({success:true});res.json({success:false});});app.get('/health',(req,res)=>{res.json({status:'ok'});});app.listen(PORT,()=>{console.log(`Backend running on port ${PORT}`);});
